<!DOCTYPE HTML>
<html>
<head>
  <title>Vendas Ateliê de Obras</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
  <h1>Ateliê - Cadastro de Vendas</h1>

  <h3>Nova Venda</h3>
  <table>
    <tr>
      <td>Código do cliente:</td>
      <td><input type="text" id="codigoCliente" size="50"></td>
    </tr>
    <tr>
      <td>Nome da obra:</td>
      <td><input type="text" id="nomeProduto" size="50"></td>
    </tr>
    <tr>
      <td>Preço da obra:</td>
      <td><input type="text" id="precoProduto" size="20"></td>
    </tr>
    <tr>
      <td>Quantidade:</td>
      <td><input type="text" id="quantidade" size="20"></td>
    </tr>
    <tr>
      <td>Celular:</td>
      <td><input type="text" id="celular" size="30"></td>
    </tr>
    <tr>
      <td>Artista:</td>
      <td><input type="text" id="artista" size="50"></td>
    </tr>
    <tr>
      <td>Material usado:</td>
      <td><input type="text" id="material" size="50"></td>
    </tr>
    <tr>
      <td>Tipo da obra:</td>
      <td>
        <select id="tipoObra">
          <option value="ceramica">Cerâmica</option>
          <option value="bordado">Bordado</option>
          <option value="desenho">Desenho</option>
          <option value="pintura">Pintura</option>
          <option value="outro">Outro</option>
        </select>
      </td>
    </tr>
  </table>
  <button onclick="criarVenda()">Adicionar</button>

  <h3>Maior Venda</h3>
  <div id="maiorVenda">Carregando...</div>

  <h3>Menor Venda</h3>
  <div id="menorVenda">Carregando...</div>

  <h3>Listagem de Vendas</h3>
  <div id="listaVendas">Carregando...</div>

<script type="text/javascript">
  const urlProcessarVenda = "http://localhost:9000/v1/processarVenda";
  const urlVendas = "http://localhost:9000/v1/venda";

  async function criarVenda() {
    const codCliente = document.getElementById("codigoCliente").value;
    const nomeProduto = document.getElementById("nomeProduto").value;
    const precoProduto = document.getElementById("precoProduto").value;
    const quantidade = document.getElementById("quantidade").value;
    const celular = document.getElementById("celular").value;
    const artista = document.getElementById("artista").value;
    const material = document.getElementById("material").value;
    const tipoObra = document.getElementById("tipoObra").value;

    const body = {
      codCliente,
      nomeProduto,
      precoProduto,
      quantidade,
      celular,
      artista,
      material,
      tipoObra
    };

    try {
      const response = await fetch(urlProcessarVenda, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const resultado = await response.text();

      if (!response.ok) {
        throw new Error(resultado);
      }

      alert("Venda cadastrada com sucesso! ID: " + resultado);

      document.getElementById("codigoCliente").value = "";
      document.getElementById("nomeProduto").value = "";
      document.getElementById("precoProduto").value = "";
      document.getElementById("quantidade").value = "";
      document.getElementById("celular").value = "";
      document.getElementById("artista").value = "";
      document.getElementById("material").value = "";
      document.getElementById("tipoObra").value = "ceramica";

      carregarVendas();
      carregarMaiorVenda();
      carregarMenorVenda();
    } catch (error) {
      alert("Erro ao cadastrar venda: " + error.message);
    }
  }

  async function carregarVendas() {
    try {
      const response = await fetch(urlVendas);
      const vendas = await response.json();
      const listaVendas = document.getElementById("listaVendas");
      listaVendas.innerHTML = "";

      if (!vendas.length) {
        listaVendas.innerHTML = `Nenhuma venda cadastrada<br><br><input type='button' onclick='carregarVendas()' value='Atualizar'/>`;
        return;
      }

      let linhas = "<tr><th>Cliente</th><th>Celular</th><th>Obra</th><th>Tipo</th><th>Artista</th><th>Material</th><th>Preço</th><th>Qtd</th><th>Total</th></tr>";
      vendas.forEach(v => {
        const total = v.precoProduto * v.quantidade;
        linhas += `
          <tr>
            <td>${v.codCliente}</td>
            <td>${v.celular || '-'}</td>
            <td>${v.nomeProduto}</td>
            <td>${v.tipoObra || '-'}</td>
            <td>${v.artista || '-'}</td>
            <td>${v.material || '-'}</td>
            <td>R$ ${Number(v.precoProduto).toFixed(2)}</td>
            <td>${v.quantidade}</td>
            <td>R$ ${total.toFixed(2)}</td>
          </tr>
        `;
      });

      listaVendas.innerHTML = '<table border="1">' + linhas + '</table><br><input type="button" onclick="carregarVendas()" value="Atualizar"/>';
    } catch (error) {
      console.error("Erro ao carregar vendas:", error);
    }
  }

  async function carregarMaiorVenda() {
    try {
      const response = await fetch(`${urlVendas}/maior_venda`);
      const valor = await response.json();
      document.getElementById("maiorVenda").innerText = "R$ " + valor.toFixed(2);
    } catch (error) {
      console.error("Erro ao carregar maior venda:", error);
    }
  }

  async function carregarMenorVenda() {
    try {
      const response = await fetch(`${urlVendas}/menor_venda`);
      const valor = await response.json();
      document.getElementById("menorVenda").innerText = "R$ " + valor.toFixed(2);
    } catch (error) {
      console.error("Erro ao carregar menor venda:", error);
    }
  }

  carregarVendas();
  carregarMaiorVenda();
  carregarMenorVenda();
</script>
</body>
</html>
