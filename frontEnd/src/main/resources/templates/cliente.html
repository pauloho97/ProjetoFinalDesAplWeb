<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8" />
	<title>Cadastro de Cliente</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			background-color: #f2f2f2;
			margin: 20px;
			color: #333;
		}

		h1,
		h3 {
			color: #2c3e50;
		}

		table {
			background: #fff;
			padding: 20px;
			border-collapse: collapse;
			box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
			border-radius: 5px;
		}

		td {
			padding: 8px;
		}

		input[type="text"] {
			width: 100%;
			padding: 10px;
			font-size: 15px;
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
		}

		input[type="text"]:focus {
			border-color: #2980b9;
			outline: none;
		}

		button {
			background-color: #2980b9;
			color: white;
			padding: 10px 18px;
			border: none;
			border-radius: 4px;
			font-size: 15px;
			cursor: pointer;
			margin-top: 10px;
		}

		button:hover {
			background-color: #1c5980;
		}

		#listaClientes {
			margin-top: 20px;
		}

		#listaClientes table {
			width: 100%;
			border-collapse: collapse;
			background: #fff;
			font-size: 13px;
		}

		#listaClientes th,
		#listaClientes td {
			border: 1px solid #ccc;
			padding: 6px 8px;
			text-align: left;
		}

		#listaClientes th {
			background-color: #2980b9;
			color: white;
		}
	</style>
</head>

<body>

	<h1>Cadastro de Cliente</h1>

	<h3>Formulário</h3>
	<table>
		<tr>
			<td>Nome:</td>
			<td><input type="text" id="nome" placeholder="Nome completo"></td>
		</tr>
		<tr>
			<td>Celular:</td>
			<td><input type="text" id="celular" oninput="mascararCelular(this)" maxlength="19"
					placeholder="+55 (xx) 9xxxx-xxxx"></td>
		</tr>
		<tr>
			<td>CPF:</td>
			<td><input type="text" id="cpf" maxlength="11" oninput="permitirApenasNumeros(this)"
					placeholder="Apenas números"></td>
		</tr>
		<tr>
			<td>CEP:</td>
			<td><input type="text" id="cep" maxlength="9" oninput="mascararCep(this)" placeholder="xxxxx-xxx"></td>
		</tr>
		<tr>
			<td>Número:</td>
			<td><input type="text" id="numero" oninput="permitirApenasNumeros(this)"></td>
		</tr>
		<tr>
			<td>Complemento:</td>
			<td><input type="text" id="complemento"></td>
		</tr>
	</table>

	<button onclick="criarCliente()">Adicionar</button>

	<h3>Listagem de Clientes</h3>
	<div id="listaClientes"></div>

	<script>
		const urlAPI = "http://localhost:9000/v1/cliente";

		function permitirApenasNumeros(input) {
			input.value = input.value.replace(/\D/g, "");
		}

		let valorAnterior = "";

		function mascararCelular(input) {
			  let valor = input.value.replace(/\D/g, ""); // remove tudo que não é número

			  // Se o campo estiver vazio (ou quase), limpa totalmente
			  if (valor.length <= 2) {
			    input.value = valor ? "+" + valor : "";
			    return;
			  }

			  // Garante prefixo 55 no começo
			  if (!valor.startsWith("55")) {
			    valor = "55" + valor;
			  }

			  valor = valor.slice(2); // remove o 55 para formatar

			  // Garante no máximo 11 dígitos
			  if (valor.length > 11) {
			    valor = valor.slice(0, 11);
			  }

			  // Força o 9 depois do DDD se ainda não tiver
			  if (valor.length >= 3 && valor[2] !== '9') {
			    valor = valor.slice(0, 2) + '9' + valor.slice(2);
			  }

			  let formatado = "+55";

			  if (valor.length >= 7) {
			    formatado += valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, " ($1) $2-$3").replace(/[-\s]+$/, "");
			  } else if (valor.length >= 3) {
			    formatado += valor.replace(/^(\d{2})(\d{0,5})/, " ($1) $2");
			  } else if (valor.length > 0) {
			    formatado += " (" + valor;
			  }

			  input.value = formatado;
			}

		function mascararCep(input) {
			let valor = input.value.replace(/\D/g, "");
			if (valor.length > 8) valor = valor.slice(0, 8);
			if (valor.length >= 6) {
				input.value = valor.replace(/^(\d{5})(\d{0,3})$/, "$1-$2");
			} else {
				input.value = valor;
			}
		}

		async function criarCliente() {
			const nome = document.getElementById("nome").value.trim();
			let celularFormatado = document.getElementById("celular").value.trim();
			let celularRaw = celularFormatado.replace(/\D/g, "");
			const cpf = document.getElementById("cpf").value.trim();
			const cep = document.getElementById("cep").value.replace(/\D/g, "");
			const numeroStr = document.getElementById("numero").value.trim();
			const complemento = document.getElementById("complemento").value.trim();

			if (nome.length < 2) {
				alert("O nome deve ter pelo menos 2 caracteres.");
				return;
			}

			// Verifica se celular tem exatamente 13 dígitos e começa com 55 e DDD válido e 9 no início do número
			// 55 + 2 dígitos DDD + 9 + 8 dígitos
			if (
				celularRaw.length !== 13 ||
				!celularRaw.startsWith("55") ||
				celularRaw[4] !== "9"
			) {
				alert(
					"O celular deve estar no formato +55 (XX) 9XXXX-XXXX. Exemplo: +55 (11) 91234-5678"
				);
				return;
			}


			if (!/^\d{8}$/.test(cep)) {
				alert("CEP deve conter 8 números.");
				return;
			}

			if (!/^\d+$/.test(numeroStr)) {
				alert("Número deve conter apenas números.");
				return;
			}

			const numero = parseInt(numeroStr);

			const body = {
				nome,
				celular: celularFormatado,
				cpf,
				cep,
				numero,
				complemento,
			};

			try {
				const response = await fetch(urlAPI, {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify(body),
				});

				if (response.ok) {
					alert("Cliente cadastrado com sucesso!");
					document.getElementById("nome").value = "";
					document.getElementById("celular").value = "";
					document.getElementById("cpf").value = "";
					document.getElementById("cep").value = "";
					document.getElementById("numero").value = "";
					document.getElementById("complemento").value = "";
					carregarClientes();
				} else {
					const errorMsg = await response.text();
					alert("Erro ao cadastrar: " + errorMsg);
				}
			} catch (error) {
				alert("Erro de conexão: " + error.message);
			}
		}

		async function carregarClientes() {
			try {
				const response = await fetch(urlAPI);
				const clientes = await response.json();
				const listaClientes = document.getElementById("listaClientes");

				if (!clientes.length) {
					listaClientes.innerHTML = `Nenhum cliente cadastrado.<br><br><button onclick='carregarClientes()'>Atualizar</button>`;
					return;
				}

				let linhas = `
      <tr>
        <th>Nome</th><th>Celular</th><th>CPF</th><th>CEP</th>
        <th>Número</th><th>Complemento</th>
      </tr>`;

				clientes.forEach((cliente) => {
					linhas += `
        <tr>
          <td>${cliente.nome}</td>
          <td>${cliente.celular}</td>
          <td>${cliente.cpf}</td>
          <td>${cliente.cep}</td>
          <td>${cliente.numero}</td>
          <td>${cliente.complemento}</td>
        </tr>`;
				});

				listaClientes.innerHTML = "<table>" + linhas + "</table>";
			} catch (error) {
				alert("Erro ao carregar clientes: " + error.message);
			}
		}

		// Carrega clientes na inicialização da página
		carregarClientes();
	</script>

</body>

</html>